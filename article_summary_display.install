<?php

use Drupal\field\Entity\FieldStorageConfig;
use Drupal\field\Entity\FieldConfig;
use Drupal\node\Entity\NodeType;
use Drupal\Core\Entity\Entity\EntityFormDisplay;
use Drupal\Core\Entity\Entity\EntityViewDisplay;

/**
 * Implements hook_install().
 */
function article_summary_display_install() {
  // Check if content type "article" exists.
  if (!NodeType::load('article')) {
    \Drupal::logger('article_summary_display')->warning('Content type "article" not found. Summary field not created.');
    return;
  }

  // Create field storage if it doesn't exist.
  if (!FieldStorageConfig::loadByName('node', 'field_generated_summary')) {
    FieldStorageConfig::create([
      'field_name' => 'field_generated_summary',
      'entity_type' => 'node',
      'type' => 'string_long',
      'settings' => [],
      'cardinality' => 1,
      'translatable' => TRUE,
    ])->save();
  }

  // Create and attach field config to "article".
  if (!FieldConfig::loadByName('node', 'article', 'field_generated_summary')) {
    FieldConfig::create([
      'field_name' => 'field_generated_summary',
      'entity_type' => 'node',
      'bundle' => 'article',
      'label' => 'AI Generated Summary',
      'description' => 'Summary auto-generated by OpenAI.',
      'required' => FALSE,
      'settings' => [],
    ])->save();
  }

  // Add to form display.
  if ($form_display = EntityFormDisplay::load('node.article.default')) {
    $form_display->setComponent('field_generated_summary', [
      'type' => 'string_textarea',
      'weight' => 100,
    ])->save();
  }

  // Add to view display.
  if ($view_display = EntityViewDisplay::load('node.article.default')) {
    $view_display->setComponent('field_generated_summary', [
      'label' => 'above',
      'type' => 'string',
      'weight' => 100,
    ])->save();
  }
}

/**
 * Optional: Reattach field to article if ever missing.
 */
function article_summary_display_update_8101() {
  if (!FieldConfig::loadByName('node', 'article', 'field_generated_summary')) {
    FieldConfig::create([
      'field_name' => 'field_generated_summary',
      'entity_type' => 'node',
      'bundle' => 'article',
      'label' => 'AI Generated Summary',
      'description' => 'Summary auto-generated by OpenAI.',
      'required' => FALSE,
      'settings' => [],
    ])->save();
  }

  if ($form_display = EntityFormDisplay::load('node.article.default')) {
    $form_display->setComponent('field_generated_summary', [
      'type' => 'string_textarea',
      'weight' => 100,
    ])->save();
  }

  if ($view_display = EntityViewDisplay::load('node.article.default')) {
    $view_display->setComponent('field_generated_summary', [
      'label' => 'above',
      'type' => 'string',
      'weight' => 100,
    ])->save();
  }

  \Drupal::logger('article_summary_display')->notice('field_generated_summary successfully attached to article (update_8101).');
}
